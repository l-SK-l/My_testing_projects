# TLS шлюз

**Тонкости, названия внутрених продуктов и инструментов опущены, оставлена только основная информация**

**Данный материал не является примером методики тестирования, а только показывает используемые инструменты и подход к решению задачи!**

# Оглавление
- [TLS шлюз](#tls-шлюз)
- [Оглавление](#оглавление)
- [Настройка TLS шлюза и Нагрузочных машин](#настройка-tls-шлюза-и-нагрузочных-машин)
- [Схема стенда](#схема-стенда)
  - [Описание параметров окружения](#описание-параметров-окружения)
    - [TLS шлюз](#tls-шлюз-1)
  - [Взаимодействие](#взаимодействие)
    - [Общее описание тестирования](#общее-описание-тестирования)
  - [Управление](#управление)
    - [Сеть](#сеть)
    - [Машина управления TLS шлюзом](#машина-управления-tls-шлюзом)
    - [Мониторинг Grafana](#мониторинг-grafana)
- [Ansible](#ansible)
  - [Playbooks](#playbooks)
  - [start\_yandex\_tank\_vars.yaml](#start_yandex_tank_varsyaml)
    - [Общие параметры](#общие-параметры)
    - [rm\_tap\_files](#rm_tap_files)
    - [copy\_tap\_files](#copy_tap_files)
    - [start\_tap](#start_tap)
    - [remove\_logs](#remove_logs)
    - [deploy\_load\_TAPS\_Jmeter\_vars](#deploy_load_taps_jmeter_vars)
    - [start\_yandex\_tank\_vars](#start_yandex_tank_vars)
  - [Запуск тестов](#запуск-тестов)
- [Тесты](#тесты)
  - [Без TLS шлюза](#без-tls-шлюза)
  - [С TLS шлюзом](#с-tls-шлюзом)
- [Отчёт](#отчёт)

В DUT представлены несколько режимов работы

Все режимы тестируются в рамках одного стенда. Стенд подобран для максимальной програмно-аппаратной платформы, для более слабых платформ, стенд можно сокращать для экономии ресурсов виртуализации.

# Настройка TLS шлюза и Нагрузочных машин
По отдельным мануалам.

# Схема стенда
![DUT](https://github.com/l-SK-l/My_testing_projects/blob/main/TLS%20gateway%20(RU)/assets/DUT.png)

## Описание параметров окружения
Описание технических характеристик VMs и сетевых интерфейсов, ссылки на отдельную статью тюнинга linux под высокую нагрузку.

### TLS шлюз
Описание тонких настроек для тестирования: Лицензирование, выпуск сертификатов, формирование эмуляторов TLS туннелей, настройка сети, конфигурации Telegraf и скриптов снятия дополнительных метрик, настройка дашборда в Grafana.

## Взаимодействие
### Общее описание тестирования
Тестирование TLS шлюза построено на тестировании веб серверов с помощью инструментов расположенных на нагрузочных машинах. Т.к. делать запросы на защищённые веб сервера через TLS шлюз можно только через протокол TLS с GOST, то на нагрузочных машинах запускаются эмуляторы, поднимающие туннели с TLS шлюзом по протоколу TLS с необходимыми шифронаборами, данные туннели слушаю трафик на lo интерфейсе с определёнными портами и перенаправляют запросы в туннель до TLS шлюза, а тот в своё очередь на защищённые ресурсы и обратно до нагрузочных машин.
![interaction](https://github.com/l-SK-l/My_testing_projects/blob/main/TLS%20gateway%20(RU)/assets/interaction.png)

В качестве нагрузочного инструмента используется Yandex-Tank в связке с Jmeter. Yandex-Tank оставлен из за своей простоты сбора метрик, а так же из за лёгкой отладки при проблемах и внешнего мониторинга, если необходим более глубокий анализ результатов.

## Управление
### Сеть
Описание сетевой части: адресация, сетевое взаимодействие управления и мониторинга.

### Машина управления TLS шлюзом
Данная VM предназначена для управления TLS шлюзом через WEB интерфейс и SSH, описывается процедура выпуска лицензий, управление сертификатами и клиентом с TLS шифрованием.

### Мониторинг Grafana
На всех хостах стенда установлен Telegraf, в его конфигурации по пути `/etc/telegraf/telegraf.conf` указан сервер InfluxDB и имя базы данных в которую собираются все метрики.

```
[[outputs.influxdb]]
  # urls = ["http://x.x.x.x:8086"] # CHANGE THIS!
  # database = "xxx" # CHANGE THIS!
```
Приложен пример конфигурации с коментариями к параметрам, описано где в Grafana указывается внешняя база InfluxDB и как она указывается в переменных Grafana.

# Ansible
Управление всеми тестами происходит через Ansible-playbook на Машине управления тестами **Ansible\InfluxDB**

## Playbooks
Playbooks находятся по пути `/etc/ansible/playbooks`, для удобства запускаются из этой же директории.
Рассмотрим их подробнее:
## start_yandex_tank_vars.yaml

```
---
- hosts: taps
  gather_facts: false
  vars:
    async_value: 21600 #Асинхронный запуск минуту через сколько секунд отключится программа,starttap
    cipher: XXX #Указываем шифронабор из нескольких варинтов
  roles:
    - rm_tap_files
    - copy_tap_files
    - start_tap
- hosts: web-servers
  gather_facts: false
  tasks:      
    - name: remove logs from web server
      command: sh /root/clear_log.sh
- hosts: taps
  gather_facts: true
  roles:
    - remove_logs
    - deploy_load_TAPS_Jmeter_vars #Роль по копированию конфигураций яндекс танка и jmeter
    - start_yandex_tank_vars
  vars:
     users: 20000 #Колличество пользователей в тесте на одну нагрузочную VM
     rps: 3000 #Колличество RPS в теста, max и stable на одну нагрузочную VM
     time_all: 900 #Общее время теста, должно ровняться сумме time_step 1 и 2
     time_step_1: 600 #Время набора результатов
     time_step_2: 300 #Время удержания результатов
     addr: 127.0.0.1 #Адрес веб сервера или localhost
     http_port: xxx #Порт веб сервера или localhost
     file_name: xxx.html #Запрашиваемая страница с веб сервера
     async_value: 2400 #Время ожидания выполнения всей задачи
     poll: 0

- hosts: taps
  gather_facts: false
  tasks:
    - pause: seconds=10
    - name: remove logs
      command: sh /root/rm_logs.sh
```
Все переменные подписаны в комментариях после #, переменные нужны для более простого запуска теста из консоли, не редактируя значения в файле, пример команды будет в самом конце. 
Рассмотрим порядок и Роли более подробнее.
### Общие параметры

**hosts: taps**
Параметр hosts определяет группу хостов, на которую будут распространяться действия ниже. Файл hosts находится по пути `/etc/ansible/hosts` и в нём перечислены адреса Нагрузочных машин в сети управления.

**gather_facts: true/false**
Модуль, собирающий информацию о удалённой системе для последующего использования переменных, например hostname или версию ОС.

**async_value:** 
Асинхронный запуск команд, через сколько секунд отключится программа, если она не завершится сама или мы её не завершим принудительно. Ansible будет поддерживать связь с хостом, для контроля задачи.

**vars:**
Переменные, которые будут пробрасываться в конфигурационные файлы перед копированием их на удалённые хосты. Данный параметр можно менять из консоли через `–extra-vars` или `-e`, такой параметр будет более приоритетным, чем указанный в конфиге.

**tasks:** 
Простые задания, например выполнение команд на удалённых машинах.

**roles:**
Это набор файлов, задач, шаблонов, переменных и обработчиков, которые вместе служат определенной цели. Роли будут рассмотрены более подробнее далее.

###  rm_tap_files
Задача текущей роли: удалить старые скрипты запуска TAP, т.к. число скриптов можно будет менять в зависимости от TLS шлюза и числа физических интерфейсов.

```
- name: tap_scripts_rm
  shell: rm -rf /root/tap/tap_start*
```
### copy_tap_files
Задача текущей роли: Подставить в темплейты скриптов шифронабор `{{ cipher }}` и скопировать скрипты запуска TAP на Нагрузочные машины. В задаче перечислены все скрипты запуска по отдельности.
**ВНИМАНИЕ**
В данной роли, в файле `/etc/ansible/roles/copy_tap_files/tasks/maim.yml` перечислены 16 скриптов для 2 физических интерфейсов, если для теста не нужно 2 физических интерфейс, например тестируется не старшие платформы, то необходимо закомментировать вторую половину конфига.
Сама задача в сокращённом виде:

```
- name: copy tap
  template:
    src: tap_start.j2
    dest: /root/tap/tap_start.sh
    mode: 0777
....
- name: copy tap15
  template:
    src: tap_start15.j2
    dest: /root/tap/tap_start15.sh
    mode: 0777
```
Тут было описание скриптов эмулирующий TLS туннели-TAP

### start_tap
Задача текущей роли: Запустить скрипты TAP на Нагрузочной машине и залогировать их работу. Лог сохраняется на каждой Нагрузочной машине `/root/logs_tap.sh.log`

```
- name: run tap
  shell: ls /root/tap/*.sh | xargs -n 1 -I{} -P666 sh {} > logs_tap.sh.log 2>&1
  args:
    executable: /bin/bash
```
### remove_logs
Задача текущей роли: Подчистка различного мусора на Нагрузочных машинах

```
- name: Remove logs
  shell: rm -rf /root/wget-log* && rm -rf /root/java_pid* && rm -rf /root/xxx.* && rm -rf /root/xxx.* && rm -rf /root/xxx.* && rm -rf /root/index* && rm -Rfv /root/xxx && rm -Rfv /root/xxx && rm -rf /root/.ansible_async/* && rm -Rfv /root/*.html*
```
### deploy_load_TAPS_Jmeter_vars
Задача текущей роли: Передать значения переменных в конфиги Jmeter, YandexTank и скрипт запуска YandexTank, после чего разложить файлы на нагрузочных машинах. 

```
- name: copy load_TAPS #копирование конфига для ятанка на целевые машины, т.е. слонов
  template:
    src: load_TAPS_Jmeter.j2
    dest: /root/load_TAPS_Jmeter.yaml    
- name: copy .jmx #Копирование конфига для Jmeter
  template:
    src: test.j2
    dest: /root/test.jmx
    mode: 0777
- name: copy yatank_script.sh #Копирование конфига для запуска YandexTank
  template:
    src: yatank_script.j2
    dest: /root/yatank_script.sh
    mode: 0777
```
Скрипт запуска YandexTank

```
#!/bin/bash
time_kill=$(( {{ time_all }} + 300 ))
while true;do
yandex-tank -c /root/load_TAPS_Jmeter.yaml&
sleep $time_kill; 
killall -s SIGINT yandex-tank & killall -9 java & killall -9 tap; 
break; 
done
```
В скрипт запуска так же через переменные пробрасывается время теста `{{ time_all }}` и к нему добавляется 300 секунд для передачи последних метрик (можно уменьшить, если тест не высоконагружен), после чего, если тест не завершился корректно, то процессы Yandex-tank, jmeter и скрипты tap будут завершены принудительно через kill.
После прохождения теста, дополнительное время необходимо для передачи всех метрик, которые долго обрабатываются при высоконагруженных тестах.

### start_yandex_tank_vars
Задача текущей роли: Запустить тест через Yandex-tank и залогировать его работу. Лог сохраняется на каждой Нагрузочной машине `/root/logs_script.sh.log`

```
- name: start yandex-tank
  shell: sh yatank_script.sh > logs_script.sh.log 2>&1
```

## Запуск тестов
Запуск тестов производится из директории `/etc/ansible/playbooks`, с помощью команды `ansible-playbook start_yandex_tank_vars.yaml -e "users=xxx rps=xxx addr=xxx http_port=xxx file_name=xxx.html cipher=xxx"` где в переменные можно указать нужные параметры, не заходя в отдельные конфиги. По умолчанию тест длится 15 минут + через 300 секунд все процессы будут завершены принудительно!
При необходимости можно запустить отдельные плейбуки:

**stop_yandex_tank.yaml** - Остановить процессы YandexTank

**stop_taps.yaml** - Остановить процессы TAP и YandexTank

**start_taps.yaml** - Запустить процессы TAP

**start_yandex_tank.yaml** - Запустить процессы YandexTank

**reboot_taps.yaml** - Перезагрузить нагрузочные машины

# Тесты
Описывается порядок тестирования и на что нужно обратить внимание.

## Без TLS шлюза
Данные тесты производятся исключительно для того, чтобы удостовериться, что тестовая среда "чистая" и не является узким местом. Тесты без TLS шлюза ВСЕГДА должны быть лучше, чем с ним!
Запускаются основные тесты показывающие максимальную производительность и стабильность. Выполняют перед всеми тестами.

## С TLS шлюзом
Подробно описаны тесты, с какими шифронаборами выполняются, что измеряется с примерами команд и скриншотами результатов. Так же для примера описан один тест с шагами, действиями тестировщика и ожидаемым результатом.

# Отчёт
Тесты должны быть зафиксированы в Отчёте.
Отчёт состоит из Шапки, Сводных данных. Конфигурации стенда и Результатов тестирования.
В шапке должна присутствовать информация о Датах, Версии и Исполнителе.
В Сводные данные заносится краткая информация о результатах теста.
В конфигурации фиксируется информация о платформе.
В Результаты заносятся более подробная информация о каждом тесте, а именно: 
- Присутствует ссылка на дашборд Grafana, отфильтрованная по времени теста
- Присутствует скриншот панели со сводными результатами, где отражена общая информация о результатах теста.
- Присутствует скриншоты из командной строки системы с выводом диагностических команд определённых частей системы.
- Указываются частные настройки стенда при необходимости.
- В случае нестандартного поведение, вносится информация в свободной форме с приложенными диагностическими файлами.

В случае тестирования максимальной производительности, результаты тестов снимаются при стабильной нагрузки, в последние минуты теста. 

Если ошибки начали появляться раньше, тест перезапускается с меньшими параметрами, приблизительно на момент массового появления ошибок. 
