# SQUID ssl inspection

**Тонкости, названия внутрених продуктов и инструментов опущены, оставлена только основная информация**

**Данный материал не является примером методики тестирования, а только показывает используемые инструменты и подход к решению задачи!**

# Оглавление
- [SQUID ssl inspection](#squid-ssl-inspection)
- [Оглавление](#оглавление)
- [Схема стенда](#схема-стенда)
  - [Описание компонентов стенда](#описание-компонентов-стенда)
    - [Конфигурация стенда](#конфигурация-стенда)
  - [Описание взаимодействия](#описание-взаимодействия)
  - [K6](#k6)
    - [Запуск теста](#запуск-теста)
- [Описание тестов](#описание-тестов)
- [Мониторинг](#мониторинг)
  - [Описание средств мониторинга](#описание-средств-мониторинга)
  - [Описание мониторинга ресурсов](#описание-мониторинга-ресурсов)
- [Отчёт](#отчёт)

# Схема стенда
![DUT](https://github.com/l-SK-l/My_testing_projects/blob/main/SQUID%20ssl%20inspection%20(RU)/assets/FW.png)

## Описание компонентов стенда
Описывается схема стенда с краткими пояснениям по каждому элементу

### Конфигурация стенда
Описываются: 
- Физические настройки машин
- Конфигурация FW с описанием важных настроек
- Конфигурация сетевой части

## Описание взаимодействия
На нагрузочной машине и FW настраивается внешний DNS с опубликованой A записью Веб сервера, Нагрузочная машина запрашивает https страницу с Веб сервера, FW c Squid перехватывает DNS запрос подходящий под правило, проводит проксирует соединения проводя [MITM](https://ru.wikipedia.org/wiki/%D0%90%D1%82%D0%B0%D0%BA%D0%B0_%D0%BF%D0%BE%D1%81%D1%80%D0%B5%D0%B4%D0%BD%D0%B8%D0%BA%D0%B0) атаку, подменяя сертификаты веб сервера на самоподписанные, расшифровая трафик, тем самым производят SSL инспекцию.
Основным показателем производительности считается способность Squid обрабатывать новые подключения в секунду (CPS\RPS)


## K6
Описание конфига
```
import http from 'k6/http';

let all_duration = '600s' //Время теста

export const options = {
    discardResponseBodies: true,
    scenarios: {
        get: {
                executor: 'constant-arrival-rate', //Тип сценария
                rate:5000, //RPS
                timeUnit:"1s", //В секунду
                duration: all_duration,  //Время теста, берётся с переменной all_duration
                preAllocatedVUs: 10, //Пользователей (подключений) Минимум
                maxVUs:1000, //Пользователей (подключений) Максимум
                exec:'get_func',
                gracefulStop: '0s' //Для нескольких сценариев, вначале первый, второй с задержкой (startTime:)

        },

        },
    thresholds: { //При срабатывании трэшхолда, тестирование будет считаться не успешным
                'http_req_duration': ['p(95)<300'], //Задержки на 95 перцентиле не более 300мс
        },
};

let webUrl = "https://tst-squid.com/" //URL

export function get_func() {
  http.get(webUrl + 'index.html'); //Страница

}
```
### Запуск теста

Без настроек, запуск сценария script.js
`k6 run script.js` 

Запуск сценария в течении 30 секунд с 10 пользователями (Параметры могут содержаться в самом сценарии)
`k6 run --vus 10 --duration 30s script.js`

Запуск сценария с игнорированием проверки TLS сертификатов и записью результата в удалённую базу InfluxDB
`K6 run –insecure-skip-tls-verify –out influxdb=http://100.127.254.86:8060/k6_test script.js`

Запуск нагрузочного сценария с 5 пользователями до 10 за 3 минуты, после до 10 за 5 минут и т.д.
`k6 run --vus 5 --stage 3m:10,5m:10,10m:35,1m30s:0 script.js`

Запуск теста с дебагом запросов http
`k6 run --http-debug=full script.js`

Из Docker
`docker run -i loadimpact/k6 run - <script.js`

Из Docker в удалённый influxdb 
`docker run -i loadimpact/k6 run -<script.js --out influxdb=http://100.127.254.86:8086/k6_stable_utm`

Из Docker в локальный influxdb 
`docker run -i loadimpact/k6 run --out influxdb=http://localhost:8086/myk6db - <script.js`

Из Docker-сompose
`docker-compose run k6 run /scripts/ewoks.js`

# Описание тестов

Предварительно перед тестами необходимо убедиться в том, что тестируемая среда функционирует штатно, веб сервер доступен, при обращении с нагрузочных машин на нужную веб страницу устанавливается защищённое HTTPS соединение с TLS1.2, данные со всех узлов поступаю на мониторинг.

Для Проверки версии TLS необходимо на веб сервере или нагрузочной машине включить запись дампа трафика с нужного интерфейса в файл, с нагрузочной машины скачать нужную страницу командой `wget https://tst-squid.com/ --no-check-certificat` ,после открыть дамп и удостовериться, что защищённое соединение установилось именно с TLS1.2, в противном случае необходимо подкорректировать настройки веб сервера, указав минимальную версию для ssl шифрования 

# Мониторинг

## Описание средств мониторинга
Для мониторинга аппаратных платформ и виртуальных машин используются средства и утилиты, входящие в состав операционной системы. 
Для Unix-образных операционных систем в качестве подобных утилит используются top, htop, vmstat, nload

Для сбора характеристик производительности компонентов системы предполагается использование следующих средств мониторинга:
-	SNMP
-	Telegraf
-	Grafana+InfluxDB

В качестве вспомогательных средств рекомендуется использовать netstat, ss, tcptrack, sysstat.
Краткое описание инструментов доступно в отдельной статьe wiki

## Описание мониторинга ресурсов
При проведении тестирования выполняется мониторинг следующих узлов:
- FW c Squid
-	Нагрузочные машины
-	Веб Сервер

Данные с FW c Squid снимаются с помощью SMNP (или telegraf в случае необходимости дополнительных метрик), с нагрузочных машин и Веб сервера с помощью telegraf. Все данные собираются в единый мониторинг (Grafana+InfluxDB). 

В процессе тестирования снимаются журналы использования аппаратных ресурсов системы с периодичностью в 30 секунд

Для FW c Squid включая
Процессор:
-	Утилизация процессора (в т.ч. отдельными процессами)
-	Средняя нагрузка на CPU в течении 1, 5 и 15 минут

Оперативная память:
-	Утилизация оперативной памяти (в т.ч. отдельными процессами)

Сеть:
-	Состояние интерфейсов
-	Утилизация интерфейсов

Дисковая система:
-	Средняя нагрузка на диск в течении 1, 5 и 15 минут в процентах
-	Состояние разделов /, /var, /etc

Другое:
-	Общее время работы
-	Статистика Межсетевого Экрана

Для нагрузочных машин отдельно:
-	Число запросов в секунду
-	Число потоков
-	Коды HTTP 
-	Net Codes
-	Задержки по квантилям

# Отчёт

Файл предполагает структурированное описание стенда и сводные результаты в шапке документа, а так же свободное описание тестов с пояснениями, если того требуют результаты 

Шапка, состав стенда, версии компонентов, настройки стенда и даты проведения испытаний должны быть зафиксированы в отчёте
